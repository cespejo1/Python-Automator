#OM Interface Automation Tool v1.0 by Carlos Espejo and James Barett 6.9.2016
import ctypes
import os
import openpyxl
import re

os.chdir("/Users/"+os.getlogin()+"/Desktop")

print("OM Interface Automation Tool v1.0 by Carlos Espejo and James Barett\n")

validOption = False

EnumWindows = ctypes.windll.user32.EnumWindows
EnumWindowsProc = ctypes.WINFUNCTYPE(ctypes.c_bool, ctypes.POINTER(ctypes.c_int), ctypes.POINTER(ctypes.c_int))
GetWindowText = ctypes.windll.user32.GetWindowTextW
GetWindowTextLength = ctypes.windll.user32.GetWindowTextLengthW
IsWindowVisible = ctypes.windll.user32.IsWindowVisible

partNumRegex = re.compile(r'\d\d\d\d\d\d-\d\d\d')
 
titles = []
def foreach_window(hwnd, lParam):
	if IsWindowVisible(hwnd):
		length = GetWindowTextLength(hwnd)
		buff = ctypes.create_unicode_buffer(length + 1)
		GetWindowText(hwnd, buff, length + 1)
		titles.append(buff.value)
	return True
	
	wb=openpyxl.load_workbook('Book1.xlsx')
	sheet=wb.get_sheet_by_name('Sheet1')
	return sheet['A1'].value

while validOption == False:
        choice = input("Hello! Please tell us what to do >>> ")

        print("Your choice was %s"%choice)

        if choice == "C":
                print("Calibrate")
                validOption = True
        
        elif choice == "I":
                print("Import")
                validOption = True
                wb=openpyxl.load_workbook('Book1.xlsx')
                sheet=wb.get_sheet_by_name('Sheet1')
                lastRow = sheet.max_row
                lastColumn = sheet.max_column
                array=[[0 for c in range(lastColumn)] for r in range(lastRow)]
                for r in range(1, lastRow+1, 1):
                        for c in range(1, lastColumn+1, 1):
                                if c == 1 :
                                        if partNumRegex.search(sheet.cell(row=r,column=c).value) is None:
                                                print(sheet.cell(row=r,column=c).value+" is not a valid part number")
                                                allow=input("Would you like to allow this part anyway? (Y/N): ")
                                                
                                                if allow == "N":
                                                        print("Not Allowed")
                                                        sheet.cell(row=r,column=lastColumn+1).value = "Not Allowed"
                                                        wb.save('Book1.xlsx')
                                                        break
                                                elif allow== "Y":
                                                        array[r-1][c-1]=str(sheet.cell(row=r,column=c).value)
                                                        print("Allowed")
                                                        print(array[r-1][c-1])
                                                        sheet.cell(row=r,column=lastColumn+1).value = "Allowed"
                                                        wb.save('Book1.xlsx')
                                                        
                                        else:
                                                array[r-1][c-1]=str(sheet.cell(row=r,column=c).value)
                                                print(array[r-1][c-1])
                                                
                                else:
                                        array[r-1][c-1]=str(sheet.cell(row=r,column=c).value)
                                        print(array[r-1][c-1])

        elif choice == "P":
                print("Paste")
                validOption = True
        
        elif choice == "Q":
                validOption = True
                exit()
        
        elif choice == "W":
                validOption = True
                EnumWindows(EnumWindowsProc(foreach_window), 0)
                print(titles)
                exit()
        
        else:
                print("Available options are:")
                print("C - Calibrate")
                print("I - Import")
                print("P - Paste")
                print("Q - Quit")
                print("W - Windows")
                validOption = False
         
#------Function to check if string is a part number------# Will be replaced by Regex
def isPartNumber(text):
    is6Digits = False
    is10Digits = False
    print (len(text))

    #Check if its a 6 digit part number or 10(including "-")
    if len(text) == 10:
        is10Digits = True
    elif len(text) == 6:
        is6Digits = True
    else:
        return False

    #Check requirements for a 10 digit part number
    if is10Digits:
        for i in range(0, 6):
            if not text[i].isdecimal():
                return False
        if text[6] != '-':
            ("worked not 6 dash")
            return False
        for i in range(7,10):
            if not text[i].isdecimal():
                return False
    #Check requirements for a 6 digit part number
    elif is6Digits:
        for i in range(0, 6):
            if not text[i].isdecimal():
                return False
    return True
    
#------End of module------#

#Calibrate
#Open/Read/Import
#Send/Paste/Output
#Select Window
#Handle Oracle Errors
